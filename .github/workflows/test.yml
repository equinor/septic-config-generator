name: '🧪 Test code'
on:
  workflow_dispatch:
  workflow_call:

env:
  CARGO_TERM_COLOR: always

jobs:
  code_test:
    name: '🛠️ Build & 🧪 Test'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: 🛠️ Cargo build
        run: cargo build --verbose

      - name: 🧪 Cargo test
        run: cargo test

  coverage:
    name: 🎁 Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2


      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info

      # - name: Setup LCOV
      #   uses: hrishikesh-kadam/setup-lcov@v1

      # - name: lcov Code Coverage Report
      #   uses: JoA-MoS/lcov-reporter-action@v1.0.0-alpha.2
      #   with:
      #     lcov-file: lcov.info
      #     delete-old-comments: true
      #     omit-branch-percentage: true


      # Too dotnetty and doesn't look very good
      # - name: Setup .NET Core # Required to execute ReportGenerator
      #   uses: actions/setup-dotnet@v3
      #   with:
      #     dotnet-version: 6.x
      #     dotnet-quality: 'ga'
      # - name: ReportGenerator
      #   uses: danielpalme/ReportGenerator-GitHub-Action@5.1.19
      #   with:
      #     reports: lcov.info
      #     targetdir: coveragereport
      #     reporttypes: Html_Dark;Cobertura;MarkdownSummaryGithub


      # Detailed info in action summary
      # - uses: livewing/lcov-job-summary@v1
      #   with:
      #     lcov: lcov.info

      # Seems rather buggy
      # - uses: kcjpop/coverage-comments@v2
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     coverage-file-path: lcov.info

      # Works, boring output, branches always included
      # - uses: zgosalvez/github-actions-report-lcov@v3
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     update-comment: true

      # Old, zgosalvez is newer
      # - uses: dethereum/github-actions-report-lcov@v1.0.0
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Publish Test Results
      #   uses: EnricoMi/publish-unit-test-result-action@v2
      #   with:
      #     files: lcov.info


      # To add to job summary:
      # - run: |
      #     cat coveragereport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

      # To add PR comment:
      # - uses: marocchino/sticky-pull-request-comment@v2
      #   if: github.event_name == 'pull_request'
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md