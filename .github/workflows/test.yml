name: 'ğŸ§ª Test code'
on:
  workflow_dispatch:
  workflow_call:

env:
  CARGO_TERM_COLOR: always

jobs:
  code_test:
    name: 'ğŸ› ï¸ Build & ğŸ§ª Test'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Cargo build
        run: cargo build --verbose

      - name: ğŸ§ª Cargo test
        run: cargo test

  coverage:
    name: ğŸ Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Setup LCOV
        uses: hrishikesh-kadam/setup-lcov@v1

      - uses: kcjpop/coverage-comments@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          coverage-file-path: lcov.info

      # Works, boring output, branches always included
      # - uses: zgosalvez/github-actions-report-lcov@v3
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     update-comment: true

      # Old, zgosalvez is newer
      # - uses: dethereum/github-actions-report-lcov@v1.0.0
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Publish Test Results
      #   uses: EnricoMi/publish-unit-test-result-action@v2
      #   with:
      #     files: lcov.info