name: 'üß™ Test code'
on:
  workflow_dispatch:
  workflow_call:

env:
  CARGO_TERM_COLOR: always

jobs:
  code_test:
    name: 'üõ†Ô∏è Build & üß™ Test'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Cargo build
        run: cargo build --verbose

      - name: üß™ Cargo test
        run: cargo test

  coverage:
    name: üéÅ Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate code coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Setup LCOV
        uses: hrishikesh-kadam/setup-lcov@v1

      - name: Setup .NET Core # Required to execute ReportGenerator
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.x
          dotnet-quality: 'ga'

      - name: ReportGenerator
        uses: danielpalme/ReportGenerator-GitHub-Action@5.1.19
        with:
          reports: lcov.info
          targetdir: coveragereport
          reporttypes: Html_Dark;Cobertura;MarkdownSummaryGithub

      - uses: actions/upload-artifact@v3
        with:
          name: coverage_report
          path: ./coveragereport/*

      # Detailed info, but in action summary instead of in PR
      # - uses: livewing/lcov-job-summary@v1
      #   with:
      #     lcov: lcov.info

      # Seems rather buggy
      # - uses: kcjpop/coverage-comments@v2
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     coverage-file-path: lcov.info

      # Works, boring output, branches always included
      # - uses: zgosalvez/github-actions-report-lcov@v3
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     update-comment: true

      # Old, zgosalvez is newer
      # - uses: dethereum/github-actions-report-lcov@v1.0.0
      #   with:
      #     coverage-files: lcov.info
      #     minimum-coverage: 60
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Publish Test Results
      #   uses: EnricoMi/publish-unit-test-result-action@v2
      #   with:
      #     files: lcov.info